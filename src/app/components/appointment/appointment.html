<!-- Popup de Agenda de Citas -->
<div class="appointment-popup-overlay" [class.show]="showAppointmentPopup" (click)="closePopup()">
  <div class="appointment-popup-content" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <div class="header-content">
        <div class="section-logo">
          <img src="/logos/gis-logo-color.png" alt="GIS Ingenier√≠a" class="section-logo-image">
        </div>
        <h2>üìÖ Agenda tu Cita</h2>
        <p>Reserva una consulta con nuestros expertos en ingenier√≠a civil</p>
      </div>
      <button class="close-btn" (click)="closePopup()">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>

    <div class="popup-body">
      <div class="appointment-hero">
        <div class="hero-content">
          <div class="hero-text">
            <h3>¬øListo para Transformar tu Proyecto?</h3>
            <p>
              Nuestros expertos est√°n listos para asesorarte en tu pr√≥ximo proyecto. 
              Agenda una consulta personalizada y descubre c√≥mo podemos ayudarte.
            </p>
            <div class="hero-highlights">
              <div class="highlight-item">
                <div class="highlight-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                </div>
                <span>Consulta gratuita</span>
              </div>
              <div class="highlight-item">
                <div class="highlight-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                </div>
                <span>Evaluaci√≥n personalizada</span>
              </div>
              <div class="highlight-item">
                <div class="highlight-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                  </svg>
                </div>
                <span>Presupuesto detallado</span>
              </div>
            </div>
          </div>
          <div class="hero-image">
            <img src="https://raw.githubusercontent.com/davidgrandas8908/gis-ingenieria-images/master/gis-ingenieria-images/interiores/imagen3.webp" alt="Agenda tu cita">
          </div>
        </div>
      </div>

      <div class="appointment-content">
        <div class="appointment-info-section">
          <div class="info-cards">
            <div class="info-card">
              <div class="card-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <div class="card-content">
                <h4>Horarios Disponibles</h4>
                <p>Lunes a Viernes: 8:00 AM - 6:00 PM</p>
                <p>S√°bados: 9:00 AM - 2:00 PM</p>
              </div>
            </div>

            <div class="info-card">
              <div class="card-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
              </div>
              <div class="card-content">
                <h4>Ubicaci√≥n</h4>
                <p>Consultas presenciales y virtuales disponibles</p>
                <p>Agenda flexible seg√∫n tu disponibilidad</p>
              </div>
            </div>

            <div class="info-card">
              <div class="card-icon">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </div>
              <div class="card-content">
                <h4>Confirmaci√≥n Autom√°tica</h4>
                <p>Recibir√°s confirmaci√≥n por email</p>
                <p>Evento agregado a tu calendario</p>
              </div>
            </div>
          </div>
        </div>

        <div class="appointment-form-section">
          <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()" class="appointment-form">
            <div class="form-row">
              <div class="form-group">
                <label for="name">Nombre Completo *</label>
                <input 
                  type="text" 
                  id="name" 
                  formControlName="name" 
                  placeholder="Tu nombre completo"
                  [class.error]="appointmentForm.get('name')?.invalid && appointmentForm.get('name')?.touched"
                >
                <div class="error-message" *ngIf="appointmentForm.get('name')?.invalid && appointmentForm.get('name')?.touched">
                  <span *ngIf="appointmentForm.get('name')?.errors?.['required']">El nombre es requerido</span>
                  <span *ngIf="appointmentForm.get('name')?.errors?.['minlength']">El nombre debe tener al menos 2 caracteres</span>
                </div>
              </div>

              <div class="form-group">
                <label for="email">Email *</label>
                <input 
                  type="email" 
                  id="email" 
                  formControlName="email" 
                  placeholder="tu@email.com"
                  [class.error]="appointmentForm.get('email')?.invalid && appointmentForm.get('email')?.touched"
                >
                <div class="error-message" *ngIf="appointmentForm.get('email')?.invalid && appointmentForm.get('email')?.touched">
                  <span *ngIf="appointmentForm.get('email')?.errors?.['required']">El email es requerido</span>
                  <span *ngIf="appointmentForm.get('email')?.errors?.['email']">Ingresa un email v√°lido</span>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="phone">Tel√©fono *</label>
                <input 
                  type="tel" 
                  id="phone" 
                  formControlName="phone" 
                  placeholder="+57 311 4491331"
                  [class.error]="appointmentForm.get('phone')?.invalid && appointmentForm.get('phone')?.touched"
                >
                <div class="error-message" *ngIf="appointmentForm.get('phone')?.invalid && appointmentForm.get('phone')?.touched">
                  <span *ngIf="appointmentForm.get('phone')?.errors?.['required']">El tel√©fono es requerido</span>
                  <span *ngIf="appointmentForm.get('phone')?.errors?.['pattern']">Ingresa un tel√©fono v√°lido</span>
                </div>
              </div>

              <div class="form-group">
                <label for="service">Servicio de Inter√©s *</label>
                <select 
                  id="service" 
                  formControlName="service"
                  [class.error]="appointmentForm.get('service')?.invalid && appointmentForm.get('service')?.touched"
                >
                  <option value="">Selecciona un servicio</option>
                  <option value="Impermeabilizaci√≥n">Impermeabilizaci√≥n de Fachadas y Cubiertas</option>
                  <option value="Obra Civil">Obra Civil y Urbanismo</option>
                  <option value="Interiores">Adecuaci√≥n de Interiores</option>
                  <option value="Incendios">Sistemas Contra Incendios</option>
                  <option value="Consultor√≠a">Consultor√≠a General</option>
                  <option value="Otro">Otro</option>
                </select>
                <div class="error-message" *ngIf="appointmentForm.get('service')?.invalid && appointmentForm.get('service')?.touched">
                  <span *ngIf="appointmentForm.get('service')?.errors?.['required']">Selecciona un servicio</span>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="date">Fecha de Cita *</label>
                <input 
                  type="date" 
                  id="date" 
                  formControlName="date" 
                  (change)="onDateChange($event)"
                  [class.error]="appointmentForm.get('date')?.invalid && appointmentForm.get('date')?.touched"
                >
                <div class="error-message" *ngIf="appointmentForm.get('date')?.invalid && appointmentForm.get('date')?.touched">
                  <span *ngIf="appointmentForm.get('date')?.errors?.['required']">Selecciona una fecha</span>
                </div>
              </div>

              <div class="form-group">
                <label for="time">Hora de Cita *</label>
                <select 
                  id="time" 
                  formControlName="time"
                  (change)="onTimeChange($event)"
                  [class.error]="appointmentForm.get('time')?.invalid && appointmentForm.get('time')?.touched"
                >
                  <option value="">Selecciona una hora</option>
                  <option *ngFor="let slot of availableSlots" [value]="slot">{{slot}}</option>
                </select>
                <div class="error-message" *ngIf="appointmentForm.get('time')?.invalid && appointmentForm.get('time')?.touched">
                  <span *ngIf="appointmentForm.get('time')?.errors?.['required']">Selecciona una hora</span>
                </div>
              </div>
            </div>

            <div class="form-group full-width">
              <label for="description">Descripci√≥n Adicional</label>
              <textarea 
                id="description" 
                formControlName="description" 
                placeholder="Describe brevemente tu proyecto o consulta (opcional)"
                rows="4"
                maxlength="500"
              ></textarea>
              <div class="char-count">
                {{appointmentForm.get('description')?.value?.length || 0}}/500 caracteres
              </div>
            </div>

            <div class="form-actions">
              <button 
                type="submit" 
                class="btn-submit" 
                [disabled]="appointmentForm.invalid || isSubmitting"
              >
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                </svg>
                <span *ngIf="!isSubmitting">Agendar Cita</span>
                <span *ngIf="isSubmitting">Agendando...</span>
              </button>
            </div>

            <!-- Mensajes de estado -->
            <div class="form-messages" *ngIf="submitSuccess || submitError">
              <div class="success-message" *ngIf="submitSuccess">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <div class="message-content">
                  <h4>¬°Cita Agendada Exitosamente!</h4>
                  <p>Tu cita ha sido agendada y se ha abierto Google Calendar para confirmar. Tambi√©n recibir√°s un email de confirmaci√≥n.</p>
                  <button type="button" class="btn-secondary" (click)="resetForm()">Agendar Otra Cita</button>
                </div>
              </div>

              <div class="error-message" *ngIf="submitError">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <div class="message-content">
                  <h4>Error al Agendar</h4>
                  <p>{{submitError}}</p>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="calendar-integration">
        <div class="integration-info">
          <h3>üîÑ Sincronizaci√≥n con Google Calendar</h3>
          <p>Al agendar tu cita, se crear√° autom√°ticamente un evento en tu calendario de Google con todos los detalles de la consulta.</p>
          <div class="integration-features">
            <div class="feature">
              <span class="feature-icon">üìß</span>
              <span>Invitaci√≥n por email</span>
            </div>
            <div class="feature">
              <span class="feature-icon">‚è∞</span>
              <span>Recordatorios autom√°ticos</span>
            </div>
            <div class="feature">
              <span class="feature-icon">üì±</span>
              <span>Sincronizaci√≥n m√≥vil</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
